# Shared Implementation

We will work in this example with a note model which will look this

```kotlin
data class Note(
    val id: Long?,
    val title: String,
    val content: String,
    val colorHex: Long,
    val created: LocalDateTime
)
```

Also we need to create a date time util implementation to format the created time

```kotlin
object DateTimeUtil {

    fun now(): LocalDateTime {
        return Clock.System.now().toLocalDateTime(TimeZone.currentSystemDefault())
    }

    fun toEpochMillis(dateTime: LocalDateTime): Long {
        return dateTime.toInstant(TimeZone.currentSystemDefault()).toEpochMilliseconds()
    }

    fun formatNoteDate(dateTime: LocalDateTime): String {
        val month = dateTime.month.name.lowercase().take(3).replaceFirstChar { it.uppercase() }
        val day = if(dateTime.dayOfMonth < 10) "0${dateTime.dayOfMonth}" else dateTime.dayOfMonth
        val year = dateTime.year
        val hour = if(dateTime.hour < 10) "0${dateTime.hour}" else dateTime.hour
        val minute = if(dateTime.minute < 10) "0${dateTime.minute}" else dateTime.minute

        return buildString {
            append(month)
            append(" ")
            append(day)
            append(" ")
            append(year)
            append(", ")
            append(hour)
            append(":")
            append(minute)
        }
    }
}
```

We will need to create a mapper to convert our Note entity to domain model.

```kotlin
fun NoteEntity.toNote(): Note {
    return Note(
        id = id,
        title = title,
        content = content,
        colorHex = colorHex,
        created = Instant
            .fromEpochMilliseconds(created)
            .toLocalDateTime(TimeZone.currentSystemDefault())
    )
}
```

We need to define a interface to implement it and replace it when we ran tests.

```kotlin
interface NoteDataSource {
    suspend fun insertNote(note: Note)
    suspend fun getNoteById(id: Long): Note?
    suspend fun getAllNotes(): List<Note>
    suspend fun deleteNoteById(id: Long)
}
```

Letâ€™s create the DataSource implementation implementation.

```kotlin
class NoteDataSourceImpl(db: NoteDataBase) : NoteDataSource {

    private val queries = db.noteQueries

    override suspend fun insertNote(note: Note) {
        queries.insertNote(
            note.id,
            note.title,
            note.content,
            note.color,
            DateTimeUtil.toEpochMillis(note.created)
        )
    }

    override suspend fun getNoteById(id: Long): Note? {
        return queries.getNoteById(id).executeAsOneOrNull()?.toNote()
    }

    override suspend fun getAllNotes(): List<Note> {
        return queries.getAllNotes().executeAsList().map { it.toNote() }
    }

    override suspend fun deleteNoteById(id: Long) {
        queries.deleteNoteById(id)
    }

}
```

**Note**: `db` object is autogenerated from shared `gradle` file definition.

## Database Driver Factory

We need to create the implementation which going to be consumed from both platforms.

1. Creating expected `shared` implementation: this implementation is going to be created into `commonMain` folder, its important to keep consistence when we place all implementations, all of this need to be contained into the same package name.

In this case, we will create the expected class into `data.local` package like this.

```kotlin
package com.example.notes.data.local

import com.squareup.sqldelight.db.SqlDriver

expect class DataBaseDriverFactory {
    fun createDriver(): SqlDriver
}
```

This class will provide us a database through SqlDriver object.

1. Creating actual `android` implementation: this implementation applies only for android platform.

```kotlin
actual class DataBaseDriverFactory(private val context: Context) {
    actual fun createDriver(): SqlDriver {
        return AndroidSqliteDriver(NoteDataBase.Schema, context, "note.db")
    }
}
```

1. Creating actual `iOS` implementation: this implementation applies only for iOS platform.

```kotlin
actual class DataBaseDriverFactory {
    actual fun createDriver(): SqlDriver {
        return NativeSqliteDriver(NoteDataBase.Schema, "note.db")
    }
}
```